## 白盒漏扫文件检查工具说明

## 简介

白盒漏扫文件检查工具用于对比待检查工程和基线工程的已扫描文件列表，找出待检查工程中缺失的文件。 该工具主要用于辅助白盒扫描任务，确保白盒扫描覆盖所有应扫描的文件，提升白盒扫描的完整性和准确性。

## 流程整理

1. 加载任务配置信息, 从配置数据库中获取任务相关的配置信息, 包括:
  1. 任务关联的组件信息
  2. 待检查工程和基线工程的映射关系
  3. 待检查工程配置信息
  4. 基线工程配置信息
  5. 屏蔽配置信息
  6. 路径映射配置信息
  7. 路径前缀配置信息
2. 根据待检查工程配置, 通过接口获取待检查工程最新一次运行成功的任务信息和已扫描的文件列表
  1. 任务信息包含任务ID, 任务状态, 任务开始时间, 任务结束时间, 分支节点信息
  2. 文件列表包含文件路径, 文件状态. 文件状态分为: success/failed
  3. 已扫描文件列表为该任务配置对应的所有待检查工程扫描到的文件列表的集合
  4. 不同类型的工程配置存储在不同的数据表中，他们获取数据的流程和逻辑可能不同。 当前主要包含如下3中：
     1. 有的是通过调用工程平台的 api 接口获取
     2. 有的是根据工程配置表中的信息通过 ftp 下载文件获取
     3. 还有的是直接读取指定路径的本地文件
3. 根据基线工程配置, 通过接口获取基线工程最新一次运行成功并且和待检查共分支节点相同的任务信息和已扫描的文件列表
  1. 任务信息包含任务ID, 任务状态, 任务开始时间, 任务结束时间, 分支节点信息
  2. 已扫描文件列表为该任务配置对应的所有基线工程扫描到的文件列表的集合
  3. 基线工程的选择逻辑需要可以调整, 一般情况需要现在和待检查工程相同分支节点下选择最新一次运行成功的任务, 但也可能存在特殊需求, 例如只用选择新一次成功的任务不用分支节点匹配, 或者选择指定分支节点的任务等
4. 执行检查逻辑, 对比待检查工程和基线工程的已扫描文件列表, 找出待检查工程中缺失的文件
  1. 使用路径前缀配置信息对文件路径进行处理, 将待检查工程文件列表，基线工程文件列表, 屏蔽配置信息中的路径还有路径映射配置信息中的路径都统一转化为相对路径
  2. 执行检查逻辑:
     1. 先用基线文件列表集合减去编码规范文件列表集合, 得到初步的缺失文件列表
     2. 再用初步的缺失文件列表减去屏蔽配置信息中的路径和路径映射配置信息中的路径, 得到最终的缺失文件列表
5. 输出检查结果, 将缺失文件列表进行格式化输出, 包括:
  1. 漏扫文件详情列表, 包括:
     1. 缺失文件路径
     2. 状态:
        1. missed
        2. shielded
        3. remapped
     3. shielded_by: 如果状态为shielded, 则记录是被哪个屏蔽配置的id屏蔽
     4. shielded_remark: 如果状态为shielded, 则记录屏蔽配置的备注信息
     5. remapped_by: 如果状态为remapped, 则记录是被哪个路径映射配置的id映射
     6. remapped_remark: 如果状态为remapped, 则记录路径映射配置的备注信息
     7. remapped_to: 如果状态为remapped, 则记录映射后的新路径
  2. 漏扫文件数据统计信息, 按照状态进行分类统计, 包括:
     1. missed数量
     2. shielded数量
     3. remapped数量
6. 结果再分析
   1. 缺失文件归属分组, 根据文件路径，调用公司内部文件归属接口，获取文件归属的项目组信息
   2. 缺失文件 missed 原因分类:
      1. 待检查列表中不存在
      2. 待检查列表中存在但状态为failed
      3. 通过引入待检查工程 cc.json 日志进行二次确认
   3. 首次发现时间记录, 对于每个缺失文件，查询数据库中是否已有记录
      1. 如果已有记录，则使用已有的首次发现时间
      2. 如果没有记录，则将当前检查时间作为首次发现时间
7. 持久化检查结果
  1. 生成每个任务的检查报告, 上传对象存储, 保存报告链接到数据库
  2. 检查结果保存在数据库
    1. 任务汇总信息
      1. 任务ID
      2. 缺失文件统计信息
        1. missed数量
        2. shielded数量
        3. remapped数量
      3. 报告链接
      4. 扫描时间
    2. 缺失文件详情信息
      1. 任务ID
      2. 缺失文件路径
      3. 状态
      4. 归属分组信息
      5. missed原因分类（如果状态为missed）
      6. 首次发现时间

以上为单个任务详细流程， 多对多关系下需要对每个待检查工程和基线工程组合执行上述流程，最终汇总所有组合的缺失文件结果进行输出和持久化。

## 补充说明

- 规模最大的基线工程的文件列表长度大约在 6 万条左右， 待检查工程的文件列表可能会达到 20 万条左右

## 目标

- 规则可扩展
- 扫描流程清晰可维护
- 规则之间无耦合
- 易于单元测试
- 接口简洁明了，不要过度设计

请先完成：

- 系统模块划分
- 核心对象关系图（文字描述）
- 数据流转路径
- 扩展点设计
- 不要写具体实现代码，先做架构设计。


## 希望的技术选型

- 使用 python3.10+
- 使用 sqlalchemy 作为 ORM 框架
- 使用 requests 进行接口调用
- 使用 pydantic 进行数据校验和管理
- 使用 uv 做包管理和以来管理
